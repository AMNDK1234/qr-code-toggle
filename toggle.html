<!DOCTYPE html><html><head>
<meta charset="UTF-8"><title>Toggle Status</title>
<script type="module">
import status from './status.json' assert { type:'json' };
const params = new URLSearchParams(location.search);
const id = params.get('code');
const whole = params.get('update');         // index.html POST uses ?update=1
if(whole){
   // ------- POST coming from index.html or self‑update --------------
   const data = await fetch('',{method:'POST'}).then(r=>r.json());
   await commitToGitHub(JSON.stringify(data,null,2))
   .then(()=>document.body.textContent="✅ status.json updated!");
   return;
}
if(!id || !status.codes[id]) {
   document.body.textContent="Unknown QR ID"; return;
}
const rec = status.codes[id];
rec.active = !rec.active;
await commitToGitHub(JSON.stringify(status,null,2))
  .then(()=>location.href=`./status.html`);
async function commitToGitHub(content){
 /* GitHub REST v3 – PUT file */
 const repo  = "yourUser/yourRepo";
 const path  = "status.json";
 const token = atob("{{ GH_TOKEN }}");     // injected via GitHub Secret
 /* 1) get sha hash */
 const head = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`,{
    headers:{Authorization:`token ${token}`}
 }).then(r=>r.json());
 /* 2) put new blob */
 return fetch(`https://api.github.com/repos/${repo}/contents/${path}`,{
    method:"PUT",
    headers:{Authorization:`token ${token}`,"Content-Type": "application/json"},
    body:JSON.stringify({
      message:`update ${path}`,
      content:btoa(unescape(encodeURIComponent(content))),
      sha:head.sha
    })
 });
}
</script></head><body>
Updating…
</body></html>



